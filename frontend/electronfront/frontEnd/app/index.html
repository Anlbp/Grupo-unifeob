<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Sistema - Casa das Portas e Janelas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- GOOGLE FONTS + MATERIAL ICONS -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>

/* ============================================================
     MATERIAL DESIGN 3 ‚Äî TOKENS
============================================================ */
:root {
  --md-primary: #1A73E8;
  --md-on-primary: #ffffff;

  --md-surface: #ffffff;
  --md-surface-variant: #f1f3f4;
  --md-on-surface: #202124;
  --md-on-surface-variant: #5f6368;
  --md-outline: rgba(0,0,0,0.16);

  --avatar-bg: #8AB4F8;

  --font-scale: 1;
}

/* ===================== DARK MODE ====================== */
.light {
  --md-surface: #121212;
  --md-surface-variant: #1e1e1e;
  --md-on-surface: #E8EAED;
  --md-on-surface-variant: #B0B3B8;
  --md-outline: rgba(255,255,255,0.12);
  --avatar-bg: #3c4043;
}

/* ============================================================
    GLOBAL
============================================================ */

body {
  margin: 0;
  background: var(--md-surface);
  font-family: "Roboto", sans-serif;
  color: var(--md-on-surface);
  transition: 0.3s;
  font-size: calc(16px * var(--font-scale));
}

* {
  color: var(--md-on-surface);
  box-sizing: border-box;
}

/* SCROLLBAR */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-thumb {
  background: var(--md-outline);
  border-radius: 10px;
}

/* ============================================================
    ESTILO UNIVERSAL ‚Äî INPUTS MATERIAL YOU
============================================================ */

.mdui-input {
  width: 100%;
  padding: 14px;
  border-radius: 18px; /* üî• Material YOU */
  border: 1px solid var(--md-outline);
  background: var(--md-surface-variant);
  color: var(--md-on-surface);
  font-size: calc(16px * var(--font-scale));
  outline: none;
  transition: 0.25s;
}

.mdui-input::placeholder {
  color: var(--md-on-surface-variant);
}

.mdui-input:focus {
  border: 1px solid var(--md-primary);
  background: var(--md-surface-variant);
}

/* SELECT estilo Material You */
.mdui-select {
  width: 100%;
  padding: 14px;
  border-radius: 18px;
  border: 1px solid var(--md-outline);
  background: var(--md-surface-variant) !important;
  color: var(--md-on-surface) !important;
  font-size: calc(16px * var(--font-scale));
  outline: none;
}

/* ============================================================
    MODAIS MATERIAL YOU ‚Äî ALINHADOS E PADRONIZADOS
============================================================ */

.modal-card {
  background: var(--md-surface);
  padding: 32px;
  border-radius: 26px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.35);
  border: 1px solid var(--md-outline);
  display: flex;
  flex-direction: column;
  gap: 14px; /* üî• espa√ßamento uniforme */
  margin: auto;
}

.modal-card h2 {
  text-align: center;
  font-size: calc(24px * var(--font-scale));
  color: var(--md-primary);
  margin-top: -4px;
  margin-bottom: 4px;
}

/* BOT√ïES */
.md-btn-filled {
  width: 100%;
  padding: 14px;
  border-radius: 16px;
  border: none;
  background: var(--md-primary);
  color: var(--md-on-primary);
  font-size: calc(17px * var(--font-scale));
  cursor: pointer;
  margin-top: 12px;
  transition: 0.2s;
}

.md-btn-text {
  text-align: center;
  background: none;
  border: none;
  font-size: calc(15px * var(--font-scale));
  color: var(--md-primary);
  cursor: pointer;
  margin-top: 4px;
}

/* ============================================================
    LOGIN SCREEN
============================================================ */

#loginScreen {
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.md-login-card {
  background: var(--md-surface);
  padding: 40px;
  border-radius: 28px;
  width: 100%;
  max-width: 380px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  border: 1px solid var(--md-outline);
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.md-login-card h1 {
  margin-bottom: 8px;
  font-size: calc(28px * var(--font-scale));
  color: var(--md-primary);
  text-align: center;
}

/* ============================================================
     TOPBAR / SIDEBAR (SEM ALTERA√á√ïES)
============================================================ */

.md-topbar {
  height: 64px;
  background: var(--md-surface);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 22px;
  border-bottom: 1px solid var(--md-outline);
}

.md-topbar * {
  color: var(--md-on-surface) !important;
}

.top-right {
  display: flex;
  align-items: center;
  gap: 14px;
}

.top-right .material-icons {
  font-size: calc(24px * var(--font-scale));
  cursor: pointer;
}

.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  background: var(--avatar-bg);
  display: flex;
  align-items: center;
  justify-content: center;
}


.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.md-layout {
  display: flex;
  height: calc(100vh - 64px);
}

.md-nav-rail {
  width: 80px;
  background: var(--md-surface);
  border-right: 1px solid var(--md-outline);
  padding-top: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.md-nav-rail button {
  width: 100%;
  background: none;
  border: none;
  padding: 20px 0;
  cursor: pointer;
  color: var(--md-on-surface-variant);
}

.md-nav-rail button.selected {
  color: var(--md-primary);
  border-left: 4px solid var(--md-primary);
  background: var(--md-surface-variant);
}

.md-main {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
}

.page h1 {
  font-size: calc(28px * var(--font-scale));
  margin-bottom: 12px;
  color: var(--md-primary);
}

.md-card {
  background: var(--md-surface);
  padding: 20px;
  border-radius: 20px;
  border: 1px solid var(--md-outline);
  margin-bottom: 20px;
  font-size: calc(16px * var(--font-scale));
}
/* TABELAS ESTILO MATERIAL YOU */
table.md-card {
  width: 100%;
  border-collapse: collapse;
  border-radius: 20px;
  overflow: hidden;
  background: var(--md-surface);
  border: 1px solid var(--md-outline);
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

table.md-card thead {
  background: var(--md-surface-variant);
}

table.md-card th {
  text-align: left;
  padding: 14px 16px;
  font-weight: 500;
  color: var(--md-on-surface-variant);
  font-size: calc(15px * var(--font-scale));
  border-bottom: 1px solid var(--md-outline);
}

table.md-card td {
  padding: 12px 16px;
  font-size: calc(15px * var(--font-scale));
  color: var(--md-on-surface);
  border-bottom: 1px solid var(--md-outline);
}

table.md-card tbody tr:hover {
  background: rgba(0, 0, 0, 0.04);
}

table.md-card tbody tr:nth-child(even) {
  background: var(--md-surface-variant);
}


/* ====================== ESTILOS ADICIONAIS (apenas adicionados) ====================== */

/* Barra de a√ß√µes CRUD vis√≠vel */
.crud-bar {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin: 12px 0;
}

/* Bot√µes CRUD */
.btn-crud {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid var(--md-outline);
  background: var(--md-surface-variant);
  color: var(--md-on-surface);
  cursor: pointer;
}
.btn-crud .material-icons { font-size: 18px; }
.btn-add { border-color: #1e8e3e; }     /* adicionar */
.btn-edit { border-color: #fbbc04; }    /* editar */
.btn-remove { border-color: #d93025; }  /* remover */
.btn-crud:disabled,
.btn-crud.btn-crud-disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.crud-form-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
}
.crud-form-card {
  width: 95%;
  max-width: 520px;
}
.crud-form-fields {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}
.crud-form-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.crud-form-field label {
  font-weight: 500;
  font-size: 0.95rem;
}
.crud-form-field input,
.crud-form-field select,
.crud-form-field textarea {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--md-outline);
  background: var(--md-surface-variant);
  color: var(--md-on-surface);
  font-size: calc(15px * var(--font-scale));
}
.crud-form-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

/* Elementos exclusivos de administrador (visibilidade controlada via JS ap√≥s login) */
/* Removido display: none para permitir controle via JavaScript */
.admin-only { 
  /* Visibilidade controlada via JavaScript na fun√ß√£o preencherUIposLogin() */
}

/* Cards de m√©tricas adicionais no dashboard */
.cards { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; }
.card { background: var(--md-surface); border: 1px solid var(--md-outline); border-radius: 16px; padding: 16px; }

/* Gr√°ficos (mantendo os existentes e permitindo adicionar o de lucro) */
.graficos { display: grid; grid-template-columns: 1fr; gap: 16px; }

</style>
</head>
<body>

<!-- ======================================================
      T O P B A R
====================================================== -->
<div class="md-topbar" id="topbarArea" style="display:none;">

  <div class="top-left" style="font-size:calc(20px * var(--font-scale));">
    Casa das Portas e Janelas
  </div>

  <div class="top-right">

    <!-- NOME + FUN√á√ÉO -->
    <div id="topUserNameBox" style="text-align:right;margin-right:12px;">
      <div id="topUserNameText" style="font-size:calc(15px * var(--font-scale));font-weight:bold;"></div>
      <div id="topUserRoleText" style="font-size:calc(13px * var(--font-scale));"></div>
    </div>

    <!-- AVATAR -->
    <div class="avatar" id="avatarArea">
      <span class="material-icons" id="avatarIcon" style="color:white;">person</span>
      <img id="avatarImg" src="" style="display:none;">
    </div>

    <!-- FONT + -->
    <span class="material-icons" id="fontPlusBtn"
      style="cursor:pointer;font-size:calc(24px * var(--font-scale));margin-left:15px;">
      zoom_in
    </span>

    <!-- FONT - -->
    <span class="material-icons" id="fontMinusBtn"
      style="cursor:pointer;font-size:calc(24px * var(--font-scale));margin-left:10px;">
      zoom_out
    </span>

    <!-- THEME -->
    <span class="material-icons" id="themeToggle"
      style="cursor:pointer;font-size:calc(24px * var(--font-scale));margin-left:10px;">
      dark_mode
    </span>

    <!-- LOGOUT -->
    <span class="material-icons" id="logoutBtn"
      style="cursor:pointer;font-size:calc(24px * var(--font-scale));margin-left:10px;">
      logout
    </span>

  </div>
</div>

<!-- ======================================================
      L O G I N
====================================================== -->

<div id="loginScreen" style="display:flex;">

  <div class="md-login-card">

    <h1>Login</h1>

    <input id="cpfInput" class="mdui-input" placeholder="CPF">
    <input id="senhaInput" type="password" class="mdui-input" placeholder="Senha">

    <button class="md-btn-filled" onclick="doLogin()">Entrar</button>

    <button class="md-btn-text" onclick="abrirRecuperacao()">
      Esqueci minha senha
    </button>

  </div>

</div>

<!-- ======================================================
      L A Y O U T   PRINCIPAL
====================================================== -->

<div class="md-layout" id="mainApp" style="display:none;">

  <!-- NAVIGATION RAIL -->
  <aside class="md-nav-rail">

    <button onclick="abrirPagina('dashboard')" data-page="dashboard" class="nav-item selected">
      <span class="material-icons">dashboard</span>
    </button>

    <button onclick="abrirPagina('clientes')" data-page="clientes" class="nav-item">
      <span class="material-icons">people</span>
    </button>

    <button onclick="abrirPagina('produtos')" data-page="produtos" class="nav-item">
      <span class="material-icons">inventory_2</span>
    </button>

   <button onclick="abrirPagina('vendas')" data-page="vendas" class="nav-item">
      <span class="material-icons">shopping_cart</span>
   </button>


    <button onclick="abrirCadastro()" data-page="adminCadastro" class="nav-item admin-only">
      <span class="material-icons">person_add</span>
    </button>

    <!-- ADI√á√ÉO: Bot√£o Auditoria (apenas adicionando, sem remover nada) -->
    <button onclick="abrirPagina('auditoria')" data-page="auditoria" class="nav-item admin-only">
      <span class="material-icons">manage_search</span>
    </button>

  </aside>

  <!-- ======================================================
        P √Å G I N A S
  ====================================================== -->
  <main class="md-main">

<main class="md-main">

  <!-- DASHBOARD -->
  <div class="page" id="dashboard" style="display:block;">
    <h1>Dashboard</h1>
    <div class="md-card">Bem-vindo ao painel geral.</div>

    <!-- ADI√á√ÉO: Cards de m√©tricas com lucro (sem remover nada existente) -->
    <div class="cards">
      <div class="card">
        <h3>Total de Clientes</h3>
        <p id="total-clientes">0</p>
      </div>
      <div class="card">
        <h3>Total de Vendas</h3>
        <p id="total-vendas">0</p>
      </div>
      <div class="card">
        <h3>Faturamento</h3>
        <p id="faturamento">R$ 0,00</p>
      </div>
      <div class="card">
        <h3>Lucro</h3>
        <p id="lucro">R$ 0,00</p>
      </div>
    </div>

    <!-- ADI√á√ÉO: Gr√°fico de lucro (mantendo os j√° existentes abaixo) -->
    <div class="graficos">
      <canvas id="grafico-lucro"></canvas>
    </div>
  </div>

  <!-- CLIENTES -->
  <div class="page" id="clientes" style="display:none;">
    <h1>Clientes</h1>

    <!-- ADI√á√ÉO: Barra de a√ß√µes CRUD sempre vis√≠vel -->
    <div class="crud-bar">
      <button class="btn-crud btn-add" data-crud-section="clientes" data-crud-action="add" onclick="onAdicionarClienteClick()">
        <span class="material-icons">add</span> Adicionar
      </button>
    </div>

    <table class="md-card" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>CPF/CNPJ</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>Cidade</th>
          <th>Estado</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="clientes-tbody"></tbody>
    </table>
  </div>

  <!-- PRODUTOS -->
  <div class="page" id="produtos" style="display:none;">
    <h1>Produtos</h1>

    <!-- ADI√á√ÉO: Barra de a√ß√µes CRUD sempre vis√≠vel -->
    <div class="crud-bar">
      <button class="btn-crud btn-add" data-crud-section="produtos" data-crud-action="add" onclick="onAdicionarProdutoClick()">
        <span class="material-icons">add</span> Adicionar
      </button>
    </div>

    <table class="md-card" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Categoria</th>
          <th>Pre√ßo</th>
          <th>Descri√ß√£o</th>
          <th>Estoque</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="produtos-tbody"></tbody>
    </table>
  </div>

  <!-- VENDAS -->
<div class="page" id="vendas" style="display:none;">
  <h1>Vendas</h1>

  <!-- ADI√á√ÉO: Barra de a√ß√µes CRUD sempre vis√≠vel -->
  <div class="crud-bar">
    <button class="btn-crud btn-add" data-crud-section="vendas" data-crud-action="add" onclick="onAdicionarVendaClick()">
      <span class="material-icons">add</span> Adicionar
    </button>
  </div>

  <table class="md-card" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Vendedor</th>
        <th>Total</th>
        <th>Status</th>
        <th>Forma Pagamento</th>
        <th>Data Compra</th>
        <th>Data Entrega</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="vendas-tbody"></tbody>
  </table>
</div>

  <!-- CADASTRO ADMIN -->
  <div class="page admin-only" id="adminCadastro" style="display:none;">
    <h1>Cadastrar Usu√°rio</h1>
    <div class="md-card" style="padding: 20px; margin-bottom: 20px;">
      <p>√Årea para adicionar novos usu√°rios ao sistema.</p>
      <button class="md-btn-filled" onclick="abrirCadastro()" style="margin-top: 10px;">
        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">person_add</span>
        Cadastrar Novo Usu√°rio
      </button>
    </div>
    
    <!-- Bot√£o de Auditoria -->
    <div class="md-card" style="padding: 20px;">
      <h2 style="margin-top: 0;">Logs de Auditoria</h2>
      <p>Visualize todas as a√ß√µes realizadas pelos usu√°rios do sistema.</p>
      <button class="md-btn-filled" onclick="abrirPagina('auditoria')" style="margin-top: 10px;">
        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">manage_search</span>
        Ver Logs de Auditoria
      </button>
    </div>
  </div>

<!-- ADI√á√ÉO: P√°gina de Auditoria exclusiva para Admin (apenas adicionada) -->
<div class="page admin-only" id="auditoria" style="display:none;">
  <h1>Logs de Auditoria</h1>
  <div style="margin-bottom: 20px;">
    <button class="md-btn-filled" onclick="carregarAuditoria()" style="margin-right: 10px;">
      <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">refresh</span>
      Atualizar
    </button>
  </div>
  <div style="overflow-x: auto;">
    <table class="md-card" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Usu√°rio</th>
          <th>Fun√ß√£o</th>
          <th>A√ß√£o</th>
          <th>Entidade</th>
          <th>ID Entidade</th>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody id="auditoria-tbody"></tbody>
    </table>
  </div>
</div>

</main>
</div>
<!-- ======================================================
      S I D E B A R   D E   P E R F I L
====================================================== -->

<div id="perfilSidebar" style="
  position:fixed;
  top:0;
  right:-350px;
  width:320px;
  height:100%;
  background:var(--md-surface);
  border-left:1px solid var(--md-outline);
  box-shadow:-4px 0 16px rgba(0,0,0,0.3);
  padding:20px;
  transition:0.3s;
  z-index:3000;
">

  <h2 style="color:var(--md-primary);font-size:calc(22px * var(--font-scale));">Perfil</h2>

  <div style="display:flex;justify-content:center;margin:20px 0;">
    <div class="avatar" style="width:90px;height:90px;background:var(--avatar-bg);">
      <span id="perfilAvatarIcon" class="material-icons" style="color:white;font-size:50px;">person</span>
      <img id="perfilAvatar" src="" style="display:none;width:100%;height:100%;border-radius:50%;">
    </div>
  </div>

  <p><b>Nome:</b> <span id="perfilNome"></span></p>
  <p><b>Fun√ß√£o:</b> <span id="perfilFuncao"></span></p>
  <p><b>CPF:</b> <span id="perfilCPF"></span></p>

  <button onclick="alterarAvatar()" class="md-btn-filled" style="margin-top:20px;">Alterar Foto</button>
  <button onclick="pedirLogout()" class="md-btn-filled" style="margin-top:12px;background:#d93025;">Sair</button>
  <button onclick="fecharPerfilSidebar()" class="md-btn-text" style="margin-top:10px;">Fechar</button>

</div>
<!-- ======================================================
      M O D A I S  (RECUPERA√á√ÉO, CADASTRO, AVATAR, LOGOUT)
====================================================== -->

<!-- MODAL RECUPERA√á√ÉO SENHA -->
<div id="modalRecuperar" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
  z-index:4000;
">
  <div class="modal-card">

    <h2>Recuperar Senha</h2>

    <select id="funcaoRecuperar" class="mdui-select">
      <option value="">Selecione sua fun√ß√£o</option>
      <option value="admin">Administrador</option>
      <option value="user">Usu√°rio</option>
      <option value="tecnico">T√©cnico</option>
      <option value="gerente">Gerente</option>
    </select>

    <input id="idRecuperar" class="mdui-input" placeholder="ID do usu√°rio">
    <input id="cpfRecuperar" class="mdui-input" placeholder="CPF">
    <input id="novaSenha" type="password" class="mdui-input" placeholder="Nova senha">
    <input id="confirmarSenha" type="password" class="mdui-input" placeholder="Confirmar senha">

    <button onclick="confirmarRecuperacao()" class="md-btn-filled">Alterar Senha</button>
    <button onclick="fecharRecuperacao()" class="md-btn-text">Cancelar</button>

  </div>
</div>


<!-- MODAL CADASTRO -->
<div id="modalCadastro" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
  z-index:4000;
">
  <div class="modal-card">

    <h2>Cadastrar Usu√°rio</h2>

    <select id="cadFuncao" class="mdui-select">
      <option value="">Fun√ß√£o</option>
      <option value="admin">Administrador</option>
      <option value="gerente">Gerente</option>
      <option value="vendedor">Vendedor</option>
    </select>

    <input id="cadNome" class="mdui-input" placeholder="Nome">
    <input id="cadCPF" class="mdui-input" placeholder="CPF">
    <input id="cadSenha" type="password" class="mdui-input" placeholder="Senha">

    <button onclick="confirmarCadastro()" class="md-btn-filled">Cadastrar</button>
    <button onclick="fecharCadastro()" class="md-btn-text">Cancelar</button>

  </div>
</div>


<!-- MODAL AVATAR PREVIEW -->
<div id="avatarPreviewModal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
  z-index:4000;
">
  <div class="modal-card" style="text-align:center;">

    <h2>Confirmar Foto</h2>

    <img id="avatarPreview" src="" style="
      max-width:200px; max-height:200px;
      margin:15px auto;
      border-radius:16px;
      border:2px solid var(--md-primary);
    ">

    <button id="confirmAvatarBtn" class="md-btn-filled">Usar Foto</button>
    <button id="cancelAvatarBtn" class="md-btn-text">Cancelar</button>

  </div>
</div>


<!-- MODAL LOGOUT -->
<div id="logoutModal" style="
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,0.6);
  justify-content:center; align-items:center;
  z-index:4000;
">
  <div class="modal-card" style="text-align:center;">

    <h2>Sair?</h2>
    <p style="margin:10px 0 20px 0;">Deseja encerrar sess√£o?</p>

    <button onclick="logoutConfirmado()" class="md-btn-filled" style="background:#d93025;">
      Sim
    </button>

    <button onclick="fecharLogoutModal()" class="md-btn-text">
      Cancelar
    </button>

  </div>
</div>

<!-- CRUD FORM MODAL -->
<div id="crudFormModal" class="crud-form-overlay" tabindex="-1">
  <div class="modal-card crud-form-card">
    <h2 id="crudFormTitle">Formul√°rio</h2>
    <form id="crudForm">
      <div id="crudFormFields" class="crud-form-fields"></div>
      <div class="crud-form-actions">
        <button type="submit" id="crudFormSubmit" class="md-btn-filled" style="flex:1;">Salvar</button>
        <button type="button" id="crudFormCancel" class="md-btn-text" style="flex:1;">Cancelar</button>
      </div>
    </form>
  </div>
</div>


<!-- ======================================================
      T O A S T
====================================================== -->
<div id="toast" style="
  position:fixed; bottom:20px; right:20px;
  background:var(--md-surface);
  border:1px solid var(--md-outline);
  border-radius:16px;
  padding:14px 18px;
  min-width:200px;
  opacity:0;
  transform:translateY(20px);
  transition:0.3s;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  z-index:6000;
">
  <div id="toastTitle" style="font-weight:bold;color:var(--md-primary);margin-bottom:4px;"></div>
  <div id="toastMsg"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

/* =====================================================================
      CONSTANTES
===================================================================== */
const THEME_KEY = 'app_theme_v1';
const FONT_SCALE_KEY = 'app_font_scale_v1';
const AVATAR_KEY_PREFIX = 'avatar_path_';
const DASHBOARD_METRICS_URL = 'http://localhost:3000/dashboard/metrics';
const currencyFormatter = new Intl.NumberFormat('pt-BR', {
  style: 'currency',
  currency: 'BRL',
  minimumFractionDigits: 2
});
let graficoLucroChart = null;
let currentUser = null;
let pendingAvatarPath = null;
const crudFormModal = document.getElementById('crudFormModal');
const crudForm = document.getElementById('crudForm');
const crudFormTitle = document.getElementById('crudFormTitle');
const crudFormSubmit = document.getElementById('crudFormSubmit');
const crudFormFieldsWrapper = document.getElementById('crudFormFields');
const crudFormCancel = document.getElementById('crudFormCancel');
let crudFormResolver = null;
let crudFormCurrentFields = [];

/* =====================================================================
      TEMA (CLARO / ESCURO)
===================================================================== */
function applyTheme(theme) {
  if (theme === "light") {
    document.documentElement.classList.add("light");
    document.getElementById("themeToggle").textContent = "light_mode";
  } else {
    document.documentElement.classList.remove("light");
    document.getElementById("themeToggle").textContent = "dark_mode";
  }
  localStorage.setItem(THEME_KEY, theme);
}

function toggleTheme() {
  const saved = localStorage.getItem(THEME_KEY) || "dark";
  const next = saved === "light" ? "dark" : "light";
  applyTheme(next);
}

/* =====================================================================
      TAMANHO DE FONTE GLOBAL (ACESSIBILIDADE)
===================================================================== */
function applyFontScale(scale) {
  if (scale < 0.8) scale = 0.8;
  if (scale > 1.6) scale = 1.6;

  document.documentElement.style.setProperty('--font-scale', scale);
  localStorage.setItem(FONT_SCALE_KEY, scale);
}

function increaseFont() {
  const cur = parseFloat(localStorage.getItem(FONT_SCALE_KEY) || "1");
  applyFontScale(cur + 0.1);
}

function decreaseFont() {
  const cur = parseFloat(localStorage.getItem(FONT_SCALE_KEY) || "1");
  applyFontScale(cur - 0.1);
}

/* =====================================================================
      TOAST
===================================================================== */
let toastTimeout = null;

function showToast(title, msg) {
  const t = document.getElementById("toast");
  document.getElementById("toastTitle").textContent = title;
  document.getElementById("toastMsg").textContent = msg;

  t.style.opacity = "1";
  t.style.transform = "translateY(0px)";

  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateY(20px)";
  }, 2500);
}

/* =====================================================================
      PERMISS√ïES POR FUN√á√ÉO
===================================================================== */
const CRUD_RULES = {
  clientes: {
    add: ['admin'],
    edit: ['admin', 'gerente'],
    remove: ['admin']
  },
  produtos: {
    add: ['admin'],
    edit: ['admin', 'gerente'],
    remove: ['admin']
  },
  vendas: {
    add: ['admin', 'gerente', 'vendedor'],
    edit: ['admin', 'gerente'],
    remove: ['admin']
  }
};

function getUserRole() {
  return (currentUser?.role || currentUser?.tipo || '').toLowerCase();
}

function getUserName() {
  return currentUser?.nome || currentUser?.name || '';
}

function isAdmin() {
  return getUserRole() === 'admin';
}

function canPerform(section, action) {
  if (!section || !action) return false;
  const role = getUserRole();
  if (!role) return false;
  const allowedRoles = CRUD_RULES[section]?.[action];
  if (!allowedRoles) return false;
  return allowedRoles.includes(role);
}

function updateCrudButtons() {
  document.querySelectorAll('[data-crud-section][data-crud-action]').forEach((btn) => {
    const section = btn.getAttribute('data-crud-section');
    const action = btn.getAttribute('data-crud-action');
    const allowed = canPerform(section, action);
    btn.disabled = !allowed;
    btn.classList.toggle('btn-crud-disabled', !allowed);
    if (!allowed) {
      btn.setAttribute('title', 'Permiss√£o insuficiente para esta a√ß√£o');
    } else {
      btn.removeAttribute('title');
    }
  });
}

function buildCrudInput(field) {
  let input;
  if (field.type === 'textarea') {
    input = document.createElement('textarea');
  } else if (field.type === 'select') {
    input = document.createElement('select');
    if (field.allowEmpty) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = field.placeholder || 'Selecione';
      input.appendChild(opt);
    }
    field.options?.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = option.value;
      opt.textContent = option.label;
      input.appendChild(opt);
    });
  } else {
    input = document.createElement('input');
    input.type = field.type || 'text';
  }

  input.name = field.name;
  input.id = `crud-field-${field.name}`;
  input.value = field.value ?? '';
  if (field.placeholder) input.placeholder = field.placeholder;
  if (field.required) input.required = true;
  if (field.maxLength) input.maxLength = field.maxLength;
  if (field.min !== undefined) input.min = field.min;
  if (field.max !== undefined) input.max = field.max;
  if (field.step !== undefined) input.step = field.step;
  if (field.autocomplete) input.autocomplete = field.autocomplete;
  if (field.readOnly) input.readOnly = true;
  if (field.disabled) input.disabled = true;

  return input;
}

function resetCrudForm() {
  crudForm.reset();
  crudFormFieldsWrapper.innerHTML = '';
  crudFormResolver = null;
  crudFormCurrentFields = [];
}

function focusFirstCrudInput() {
  requestAnimationFrame(() => {
    const firstInput = crudForm.querySelector('input:not([disabled]):not([type="hidden"]), textarea:not([disabled]), select:not([disabled])');
    if (firstInput) {
      firstInput.focus({ preventScroll: true });
      if (firstInput.select) {
        firstInput.select();
      } else if (firstInput.setSelectionRange && firstInput.type !== 'number') {
        const length = firstInput.value.length;
        firstInput.setSelectionRange(length, length);
      }
    }
  });
}

function openCrudForm({ title, submitLabel = 'Salvar', fields = [] }) {
  return new Promise((resolve) => {
    crudFormResolver = resolve;
    crudFormCurrentFields = fields;
    crudFormTitle.textContent = title;
    crudFormSubmit.textContent = submitLabel;
    crudFormFieldsWrapper.innerHTML = '';

    fields.forEach((field) => {
      const fieldWrapper = document.createElement('div');
      fieldWrapper.className = 'crud-form-field';

      const label = document.createElement('label');
      label.textContent = field.label;
      label.setAttribute('for', `crud-field-${field.name}`);
      fieldWrapper.appendChild(label);

      const input = buildCrudInput(field);
      fieldWrapper.appendChild(input);
      crudFormFieldsWrapper.appendChild(fieldWrapper);
    });

    crudFormModal.style.display = 'flex';
    crudFormModal.focus();
    focusFirstCrudInput();
  });
}

function resolveCrudForm(result) {
  if (crudFormResolver) {
    const resolver = crudFormResolver;
    resetCrudForm();
    crudFormModal.style.display = 'none';
    document.activeElement?.blur?.();
    resolver(result);
  }
}

crudForm.addEventListener('submit', (event) => {
  event.preventDefault();
  const data = {};
  crudFormCurrentFields.forEach((field) => {
    const element = document.getElementById(`crud-field-${field.name}`);
    if (!element) return;
    let value = element.value;
    if (field.type === 'number' && value !== '') {
      value = Number(value);
    }
    data[field.name] = value;
  });
  resolveCrudForm(data);
});

crudFormCancel.addEventListener('click', () => resolveCrudForm(null));
crudFormModal.addEventListener('click', (event) => {
  if (event.target === crudFormModal) {
    resolveCrudForm(null);
  }
});

const API_DADOS_BASE = 'http://localhost:3000/api/dados';

async function apiRequest(method, path, body) {
  const token = localStorage.getItem("token");
  const headers = { Authorization: `Bearer ${token}` };
  if (body !== undefined) {
    headers['Content-Type'] = 'application/json';
  }

  const response = await fetch(`${API_DADOS_BASE}${path}`, {
    method,
    headers,
    body: body !== undefined ? JSON.stringify(body) : undefined
  });

  let data = {};
  try {
    data = await response.json();
  } catch (err) {
    data = {};
  }

  if (!response.ok || data.ok === false) {
    throw new Error(data.message || data.erro || 'Falha ao comunicar com o servidor.');
  }

  return data;
}

function cleanDigits(value, maxLength) {
  if (value === null || value === undefined) return null;
  const digits = value.replace(/\D/g, '');
  if (!digits) return null;
  return maxLength ? digits.slice(0, maxLength) : digits;
}

function normalizeOptional(value) {
  if (value === null || value === undefined) return null;
  const trimmed = value.trim();
  return trimmed === '' ? null : trimmed;
}

function normalizeUF(value) {
  const normalized = normalizeOptional(value);
  return normalized ? normalized.substring(0, 2).toUpperCase() : null;
}

function formatCurrencyBRL(value) {
  const amount = Number(value || 0);
  if (Number.isNaN(amount)) return currencyFormatter.format(0);
  return currencyFormatter.format(amount);
}

function formatMonthLabel(anoMes) {
  if (!anoMes || anoMes.length < 7) return '-';
  const [ano, mes] = anoMes.split('-');
  return `${mes}/${ano.slice(-2)}`;
}

async function askForId(message) {
  const result = await openCrudForm({
    title: 'Selecionar registro',
    submitLabel: 'Continuar',
    fields: [
      {
        name: 'id',
        label: message,
        type: 'number',
        min: 1,
        required: true,
        value: ''
      }
    ]
  });
  if (result === null) return null;
  const parsed = parseInt(result.id, 10);
  if (Number.isNaN(parsed) || parsed <= 0) {
    showToast("Erro", "ID inv√°lido.");
    return undefined;
  }
  return parsed;
}

async function collectClientePayload(existing = {}) {
  const result = await openCrudForm({
    title: existing.id ? 'Editar Cliente' : 'Novo Cliente',
    submitLabel: existing.id ? 'Salvar' : 'Adicionar',
    fields: [
      { name: 'nome', label: 'Nome', required: true, value: existing.nome || '' },
      { name: 'cpf', label: 'CPF (somente n√∫meros)', value: existing.cpf || '', maxLength: 14 },
      { name: 'cnpj', label: 'CNPJ (somente n√∫meros)', value: existing.cnpj || '', maxLength: 18 },
      { name: 'email', label: 'Email', type: 'email', value: existing.email || '' },
      { name: 'telefone', label: 'Telefone', value: existing.telefone || '' },
      { name: 'endereco', label: 'Endere√ßo', value: existing.endereco || '' },
      { name: 'cidade', label: 'Cidade', value: existing.cidade || '' },
      { name: 'estado', label: 'Estado (UF)', value: existing.estado || '', maxLength: 2 },
      { name: 'cep', label: 'CEP', value: existing.cep || '', maxLength: 9 }
    ]
  });
  if (result === null) return null;

  const nome = result.nome?.trim();
  if (!nome) {
    showToast("Erro", "Nome do cliente √© obrigat√≥rio.");
    return undefined;
  }

  return {
    nome,
    cpf: cleanDigits(result.cpf, 11),
    cnpj: cleanDigits(result.cnpj, 14),
    email: normalizeOptional(result.email || ''),
    telefone: normalizeOptional(result.telefone || ''),
    endereco: normalizeOptional(result.endereco || ''),
    cidade: normalizeOptional(result.cidade || ''),
    estado: normalizeUF(result.estado || ''),
    cep: cleanDigits(result.cep, 8)
  };
}

async function collectProdutoPayload(existing = {}) {
  const result = await openCrudForm({
    title: existing.id ? 'Editar Produto' : 'Novo Produto',
    submitLabel: existing.id ? 'Salvar' : 'Adicionar',
    fields: [
      { name: 'nome', label: 'Nome', required: true, value: existing.nome || '' },
      { name: 'categoria', label: 'Categoria', required: true, value: existing.categoria || '' },
      { name: 'preco', label: 'Pre√ßo (R$)', type: 'number', step: '0.01', required: true, value: existing.preco ?? '' },
      { name: 'descricao', label: 'Descri√ß√£o', type: 'textarea', value: existing.descricao || '' },
      { name: 'estoque', label: 'Estoque', type: 'number', step: '1', value: existing.estoque ?? 0 }
    ]
  });
  if (result === null) return null;

  const nome = result.nome?.trim();
  const categoria = result.categoria?.trim();
  const preco = Number(result.preco);
  const estoque = Number(result.estoque ?? 0);

  if (!nome) {
    showToast("Erro", "Nome do produto √© obrigat√≥rio.");
    return undefined;
  }
  if (!categoria) {
    showToast("Erro", "Categoria √© obrigat√≥ria.");
    return undefined;
  }
  if (Number.isNaN(preco)) {
    showToast("Erro", "Pre√ßo inv√°lido.");
    return undefined;
  }
  if (Number.isNaN(estoque)) {
    showToast("Erro", "Estoque inv√°lido.");
    return undefined;
  }

  return {
    nome,
    categoria,
    preco,
    descricao: normalizeOptional(result.descricao || ''),
    estoque
  };
}

async function collectVendaPayload(existing = {}) {
  const result = await openCrudForm({
    title: existing.id ? 'Editar Venda' : 'Nova Venda',
    submitLabel: existing.id ? 'Salvar' : 'Adicionar',
    fields: [
      { name: 'cliente_id', label: 'ID do Cliente', type: 'number', min: 1, required: true, value: existing.cliente_id ?? '', disabled: Boolean(existing.id), readOnly: Boolean(existing.id) },
      { name: 'total', label: 'Total (R$)', type: 'number', step: '0.01', required: true, value: existing.total ?? '' },
      {
        name: 'status',
        label: 'Status',
        type: 'select',
        required: true,
        value: existing.status || 'pendente',
        options: [
          { value: 'pendente', label: 'Pendente' },
          { value: 'pago', label: 'Pago' },
          { value: 'cancelado', label: 'Cancelado' }
        ]
      },
      {
        name: 'forma_pagamento',
        label: 'Forma de Pagamento',
        type: 'select',
        allowEmpty: true,
        value: existing.forma_pagamento || '',
        options: [
          { value: 'dinheiro', label: 'Dinheiro' },
          { value: 'cartao_credito', label: 'Cart√£o de Cr√©dito' },
          { value: 'cartao_debito', label: 'Cart√£o de D√©bito' },
          { value: 'pix', label: 'PIX' },
          { value: 'boleto', label: 'Boleto' },
          { value: 'transferencia', label: 'Transfer√™ncia' }
        ]
      },
      { name: 'observacoes', label: 'Observa√ß√µes', type: 'textarea', value: existing.observacoes || '' },
      { name: 'data_compra', label: 'Data da Compra', type: 'date', value: existing.data_compra ? existing.data_compra.substring(0,10) : '' },
      { name: 'data_entrega', label: 'Data de Entrega', type: 'date', value: existing.data_entrega ? existing.data_entrega.substring(0,10) : '' }
    ]
  });
  if (result === null) return null;

  const clienteId = parseInt(result.cliente_id, 10);
  const total = Number(result.total);

  if (Number.isNaN(clienteId) || clienteId <= 0) {
    showToast("Erro", "ID de cliente inv√°lido.");
    return undefined;
  }
  if (Number.isNaN(total)) {
    showToast("Erro", "Total inv√°lido.");
    return undefined;
  }

  const status = result.status || existing.status || 'pendente';
  const statusNormalized = status.toLowerCase();
  const finalStatus = ['pendente', 'pago', 'cancelado'].includes(statusNormalized)
    ? statusNormalized
    : 'pendente';

  return {
    cliente_id: clienteId,
    total,
    status: finalStatus,
    forma_pagamento: normalizeOptional(result.forma_pagamento || ''),
    observacoes: normalizeOptional(result.observacoes || ''),
    data_compra: normalizeOptional(result.data_compra || ''),
    data_entrega: normalizeOptional(result.data_entrega || '')
  };
}

/* =====================================================================
      LOGIN
===================================================================== */
async function doLogin(event) {
  if (event) event.preventDefault();

  const cpf = document.getElementById("cpfInput").value.trim();
  const password = document.getElementById("senhaInput").value.trim();

  if (!cpf || !password) {
    showToast("Erro", "Preencha CPF e senha");
    return;
  }

  try {
    const res = await window.api.login(cpf, password);

    if (res.ok) {
      currentUser = res.user;
      localStorage.setItem('token', res.token); // Armazenar o token
      preencherUIposLogin();
      showToast("Bem-vindo", getUserName());
    } else {
      showToast("Erro", res.message || "CPF ou senha incorretos");
    }

  } catch (e) {
    console.error(e);
    showToast("Erro", "Falha de comunica√ß√£o");
  }
}

/* =====================================================================
      AP√ìS LOGIN
===================================================================== */
function preencherUIposLogin() {

  document.getElementById("loginScreen").style.display = "none";
  document.getElementById("mainApp").style.display = "flex";
  document.getElementById("topbarArea").style.display = "flex";

  document.getElementById("topUserNameText").textContent = getUserName();
  document.getElementById("topUserRoleText").textContent = getUserRole();

  atualizarAvatar();
  atualizarPerfilSidebar();
  updateCrudButtons();
  carregarDashboard();

  /* ADI√á√ÉO: controle de visibilidade por fun√ß√£o (sem remover nada) */
  const tipo = getUserRole();
  const isAdminUser = tipo === 'admin';
  
  document.querySelectorAll('.admin-only').forEach(el => {
    if (isAdminUser) {
      // Para bot√µes na navega√ß√£o, mostrar normalmente
      if (el.classList.contains('nav-item')) {
        el.style.display = 'block';
      } else if (el.classList.contains('page')) {
        // Para p√°ginas, n√£o alterar o display aqui (ser√° controlado pela fun√ß√£o abrirPagina)
        // Apenas garantir que n√£o est√° for√ßado como none se n√£o for a p√°gina ativa
        // As p√°ginas come√ßam com display:none inline, ent√£o n√£o mexemos aqui
      } else {
        // Para outros elementos, mostrar
        el.style.display = 'block';
      }
    } else {
      // Ocultar para n√£o-admins
      el.style.display = 'none';
    }
  });
}

function temPermissao(section = 'vendas', action = 'edit') {
  return canPerform(section, action);
}

/* =====================================================================
      AVATAR
===================================================================== */
function atualizarAvatar() {
  const avatarPath = localStorage.getItem(AVATAR_KEY_PREFIX + currentUser.cpf);

  if (avatarPath) {
    document.getElementById("avatarImg").src = `file://${avatarPath}`;
    document.getElementById("avatarImg").style.display = "block";
    document.getElementById("avatarIcon").style.display = "none";
  }
}

async function alterarAvatar() {
  try {
    const result = await window.api.chooseAvatar();

    if (result.canceled) return;
    pendingAvatarPath = result.filePaths[0];

    document.getElementById("avatarPreview").src = `file://${pendingAvatarPath}`;
    document.getElementById("avatarPreviewModal").style.display = "flex";

  } catch (err) {
    console.error(err);
    showToast("Erro", "Falha ao escolher imagem");
  }
}

document.getElementById("confirmAvatarBtn").addEventListener("click", () => {
  if (!pendingAvatarPath) return;

  localStorage.setItem(AVATAR_KEY_PREFIX + currentUser.cpf, pendingAvatarPath);

  document.getElementById("avatarImg").src = `file://${pendingAvatarPath}`;
  document.getElementById("avatarImg").style.display = "block";
  document.getElementById("avatarIcon").style.display = "none";

  document.getElementById("perfilAvatar").src = `file://${pendingAvatarPath}`;
  document.getElementById("perfilAvatar").style.display = "block";
  document.getElementById("perfilAvatarIcon").style.display = "none";

  document.getElementById("avatarPreviewModal").style.display = "none";
  showToast("Foto atualizada", "Avatar alterado com sucesso");
});

document.getElementById("cancelAvatarBtn").addEventListener("click", () => {
  document.getElementById("avatarPreviewModal").style.display = "none";
});

/* =====================================================================
      PERFIL LATERAL
===================================================================== */
function maskCPF(cpf) {
  return cpf.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, "***.$2.$3-$4");
}

function atualizarPerfilSidebar() {
  document.getElementById("perfilNome").textContent = getUserName();
  document.getElementById("perfilFuncao").textContent = getUserRole();
  document.getElementById("perfilCPF").textContent = maskCPF(currentUser.cpf);

  const avatarPath = localStorage.getItem(AVATAR_KEY_PREFIX + currentUser.cpf);
  if (avatarPath) {
    document.getElementById("perfilAvatar").src = `file://${avatarPath}`;
    document.getElementById("perfilAvatar").style.display = "block";
    document.getElementById("perfilAvatarIcon").style.display = "none";
  }
}

document.getElementById("avatarArea").addEventListener("click", () => {
  document.getElementById("perfilSidebar").style.right = "0";
});

function fecharPerfilSidebar() {
  document.getElementById("perfilSidebar").style.right = "-350px";
}


/* =====================================================================
      NAVEGA√á√ÉO ENTRE P√ÅGINAS
===================================================================== */
function abrirPagina(id) {
  document.querySelectorAll(".page").forEach(p => p.style.display = "none");
  document.getElementById(id).style.display = "block";

  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("selected"));
  document.querySelector(`[data-page="${id}"]`).classList.add("selected");

  if (id === "dashboard") carregarDashboard();
  if (id === "clientes") carregarClientes();
  if (id === "produtos") carregarProdutos();
  if (id === "vendas") carregarVendas();
  if (id === "auditoria") carregarAuditoria();
}

/* =====================================================================
      LOGOUT
===================================================================== */
document.getElementById("logoutBtn").addEventListener("click", pedirLogout);

function pedirLogout() {
  document.getElementById("logoutModal").style.display = "flex";
}

function fecharLogoutModal() {
  document.getElementById("logoutModal").style.display = "none";
}

function logoutConfirmado() {

  currentUser = null;

  document.getElementById("logoutModal").style.display = "none";
  document.getElementById("mainApp").style.display = "none";
  document.getElementById("topbarArea").style.display = "none";

  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("cpfInput").value = "";
  document.getElementById("senhaInput").value = "";

  showToast("Sess√£o encerrada", "Voc√™ saiu do sistema");

  /* ADI√á√ÉO: garantir fechamento do sidebar ao sair */
  fecharPerfilSidebar();
}

/* =====================================================================
      MODAL ‚Äî RECUPERAR SENHA
===================================================================== */
function abrirRecuperacao() {
  document.getElementById("modalRecuperar").style.display = "flex";
}

function fecharRecuperacao() {
  document.getElementById("modalRecuperar").style.display = "none";
}

async function confirmarRecuperacao() {
  const funcao = document.getElementById("funcaoRecuperar").value;
  const idUser = document.getElementById("idRecuperar").value;
  const cpf = document.getElementById("cpfRecuperar").value;
  const nova = document.getElementById("novaSenha").value;
  const conf = document.getElementById("confirmarSenha").value;

  if (!funcao || !idUser || !cpf || !nova || !conf) {
    showToast("Erro", "Preencha todos os campos");
    return;
  }

  if (nova !== conf) {
    showToast("Erro", "Senhas diferentes");
    return;
  }

  try {
    const r = await window.api.changePassword(cpf, idUser, nova);

    if (r.ok) {
      showToast("Sucesso", "Senha alterada");
      fecharRecuperacao();
    } else {
      showToast("Erro", r.message);
    }

  } catch {
    showToast("Erro", "Falha no servidor");
  }
}

/* =====================================================================
      MODAL ‚Äî CADASTRAR USU√ÅRIO
===================================================================== */
function abrirCadastro() {
  document.getElementById("modalCadastro").style.display = "flex";
}

function fecharCadastro() {
  document.getElementById("modalCadastro").style.display = "none";
}

async function confirmarCadastro() {
  const funcao = document.getElementById("cadFuncao").value;
  const nome = document.getElementById("cadNome").value;
  const cpf = document.getElementById("cadCPF").value;
  const senha = document.getElementById("cadSenha").value;

  if (!funcao || !nome || !cpf || !senha) {
    showToast("Erro", "Preencha todos os campos");
    return;
  }

  if (!isAdmin()) {
    showToast("Erro", "Apenas administradores podem cadastrar");
    return;
  }

  try {
    const token = localStorage.getItem('token'); // Assumindo que o token est√° armazenado
    const r = await window.api.createUser({
      nome,
      cpf,
      senha,
      role: funcao,
      username: cpf,
      token
    });

    if (r.ok) {
      showToast("Sucesso", "Usu√°rio cadastrado");
      fecharCadastro();
    } else {
      showToast("Erro", r.message);
    }

  } catch {
    showToast("Erro", "Falha no servidor");
  }
}

/* =====================================================================
      FUN√á√ïES EXISTENTES DE VENDAS (mantidas)
===================================================================== */
function abrirModalNovaVenda() {
  if (!canPerform('vendas', 'add')) {
    showToast("Acesso negado", "Voc√™ n√£o tem permiss√£o para criar vendas");
    return;
  }
  alert("Abrir modal de Nova Venda");
}

function abrirModalEditarVenda() {
  if (!canPerform('vendas', 'edit')) {
    showToast("Acesso negado", "Voc√™ n√£o tem permiss√£o para editar vendas");
    return;
  }
  alert("Abrir modal de Editar Venda");
}

function abrirModalExcluirVenda() {
  if (!canPerform('vendas', 'remove')) {
    showToast("Acesso negado", "Somente administradores podem excluir vendas");
    return;
  }
  alert("Abrir modal de Excluir Venda");
}

/* =====================================================================
      RENDERIZA√á√ïES EXISTENTES (mantidas)
===================================================================== */
function renderizarClientes(clientes) {
  const tbody = document.getElementById("clientes-tbody");
  tbody.innerHTML = "";

  clientes.forEach(c => {
    const tr = document.createElement("tr");

    const podeEditar = canPerform('clientes', 'edit');
    const podeRemover = canPerform('clientes', 'remove');
    let acoes = "";
    if (podeEditar || podeRemover) {
      acoes = `
        ${podeEditar ? `<button onclick="onEditarClienteClick(${c.id})" class="md-btn-text">
          <span class="material-icons">edit</span>
        </button>` : ""}
        ${podeRemover ? `<button onclick="onRemoverClienteClick(${c.id})" class="md-btn-text">
          <span class="material-icons">delete</span>
        </button>` : ""}
      `;
    }

    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.nome}</td>
      <td>${c.cpf || c.cnpj || ''}</td>
      <td>${c.email || ''}</td>
      <td>${c.telefone || ''}</td>
      <td>${c.cidade || ''}</td>
      <td>${c.estado || ''}</td>
      <td>${acoes}</td>
    `;

    tbody.appendChild(tr);
  });
}
function renderizarProdutos(produtos) {
  const tbody = document.getElementById("produtos-tbody");
  tbody.innerHTML = "";

  produtos.forEach(p => {
    const tr = document.createElement("tr");

    const estoqueClass = p.estoque < 10 ? "style='color:red;font-weight:bold;'" : "";
    const podeEditar = canPerform('produtos', 'edit');
    const podeRemover = canPerform('produtos', 'remove');
    let acoes = "";
    if (podeEditar || podeRemover) {
      acoes = `
        ${podeEditar ? `<button onclick="onEditarProdutoClick(${p.id})" class="md-btn-text">
          <span class="material-icons">edit</span>
        </button>` : ""}
        ${podeRemover ? `<button onclick="onRemoverProdutoClick(${p.id})" class="md-btn-text">
          <span class="material-icons">delete</span>
        </button>` : ""}
      `;
    }

    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.nome}</td>
      <td>${p.categoria}</td>
      <td>R$ ${p.preco}</td>
      <td>${p.descricao || ''}</td>
      <td ${estoqueClass}>${p.estoque}</td>
      <td>${acoes}</td>
    `;

    tbody.appendChild(tr);

    if (p.estoque < 10) {
      showToast("Aviso", `Produto "${p.nome}" com estoque baixo (${p.estoque})`);
    }
  });
}

function renderizarVendas(vendas) {
  const tbody = document.getElementById("vendas-tbody");
  tbody.innerHTML = "";

  vendas.forEach(v => {
    const tr = document.createElement("tr");

    const podeEditar = canPerform('vendas', 'edit');
    const podeRemover = canPerform('vendas', 'remove');
    let acoes = "";
    if (podeEditar || podeRemover) {
      acoes = `
        ${podeEditar ? `<button onclick="onEditarVendaClick(${v.id})" class="md-btn-text">
          <span class="material-icons">edit</span>
        </button>` : ""}
        ${podeRemover ? `<button onclick="onRemoverVendaClick(${v.id})" class="md-btn-text">
          <span class="material-icons">delete</span>
        </button>` : ""}
      `;
    }

    tr.innerHTML = `
      <td>${v.id}</td>
      <td>${v.cliente}</td>
      <td>${v.vendedor}</td>
      <td>R$ ${v.total}</td>
      <td>${v.status}</td>
      <td>${v.forma_pagamento}</td>
      <td>${v.data_compra}</td>
      <td>${v.data_entrega}</td>
      <td>${acoes}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* =====================================================================
      INICIALIZA√á√ÉO
===================================================================== */
window.addEventListener("DOMContentLoaded", () => {

  const savedTheme = localStorage.getItem(THEME_KEY) || "dark";
  applyTheme(savedTheme);

  const savedScale = parseFloat(localStorage.getItem(FONT_SCALE_KEY) || "1");
  applyFontScale(savedScale);

  document.getElementById("themeToggle").addEventListener("click", toggleTheme);
  document.getElementById("fontPlusBtn").addEventListener("click", increaseFont);
  document.getElementById("fontMinusBtn").addEventListener("click", decreaseFont);

  ["modalRecuperar","modalCadastro","avatarPreviewModal","logoutModal"]
    .forEach(id => {
      document.getElementById(id).addEventListener("click", e => {
        if (e.target.id === id) e.target.style.display = "none";
      });
    });

});

/* =====================================================================
      DASHBOARD
===================================================================== */
async function carregarDashboard() {
  const token = localStorage.getItem("token");
  if (!token) {
    console.warn("Token n√£o dispon√≠vel para carregar dashboard");
    return;
  }

  try {
    const res = await fetch(DASHBOARD_METRICS_URL, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();

    if (!res.ok || json.ok === false) {
      throw new Error(json.message || "N√£o foi poss√≠vel carregar as m√©tricas do dashboard.");
    }

    const metrics = json.data || {};
    atualizarCardsDashboard(metrics);
    renderizarGraficoLucro(metrics.lucroHistorico || []);
  } catch (err) {
    console.error("Erro ao carregar m√©tricas do dashboard:", err);
    showToast("Erro", err.message || "N√£o foi poss√≠vel carregar as m√©tricas do dashboard");
  }
}

function atualizarCardsDashboard(metrics = {}) {
  const {
    totalClientes = 0,
    totalVendas = 0,
    faturamento = 0,
    lucro = 0
  } = metrics;

  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) {
      el.textContent = value;
    }
  };

  setText("total-clientes", totalClientes);
  setText("total-vendas", totalVendas);
  setText("faturamento", formatCurrencyBRL(faturamento));
  setText("lucro", formatCurrencyBRL(lucro));
}

function renderizarGraficoLucro(historico = []) {
  const canvas = document.getElementById("grafico-lucro");
  if (!canvas) return;

  if (typeof Chart === "undefined") {
    console.warn("Chart.js n√£o carregado.");
    return;
  }

  const labels = (historico.length ? historico : [{ mes: "-", lucro: 0 }]).map((item) =>
    formatMonthLabel(item.mes)
  );
  const dadosLucro = (historico.length ? historico : [{ lucro: 0 }]).map((item) =>
    Number(item.lucro || 0)
  );

  const ctx = canvas.getContext("2d");
  if (graficoLucroChart) {
    graficoLucroChart.data.labels = labels;
    graficoLucroChart.data.datasets[0].data = dadosLucro;
    graficoLucroChart.update();
    return;
  }

  graficoLucroChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Lucro mensal",
          data: dadosLucro,
          borderColor: "#43A047",
          backgroundColor: "rgba(67, 160, 71, 0.2)",
          borderWidth: 3,
          tension: 0.35,
          fill: true,
          pointRadius: 4,
          pointBackgroundColor: "#1B5E20"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--md-on-surface')
          }
        },
        tooltip: {
          callbacks: {
            label: (context) => `Lucro: ${formatCurrencyBRL(context.parsed.y)}`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--md-on-surface')
          },
          grid: { display: false }
        },
        y: {
          ticks: {
            color: getComputedStyle(document.documentElement).getPropertyValue('--md-on-surface'),
            callback: (value) => formatCurrencyBRL(value)
          }
        }
      }
    }
  });
}

/* =====================================================================
      CARREGAMENTO DE DADOS EXISTENTE
===================================================================== */
async function carregarClientes() {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch("http://localhost:3000/api/dados/clientes", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();
    renderizarClientes(json.data);
  } catch (err) {
    console.error("Erro ao carregar clientes:", err);
    showToast("Erro", "N√£o foi poss√≠vel carregar clientes");
  }
}

async function carregarProdutos() {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch("http://localhost:3000/api/dados/produtos", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();
    renderizarProdutos(json.data);
  } catch (err) {
    console.error("Erro ao carregar produtos:", err);
    showToast("Erro", "N√£o foi poss√≠vel carregar produtos");
  }
}

async function carregarVendas() {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch("http://localhost:3000/api/dados/vendas", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();
    renderizarVendas(json.data); 
  } catch (err) {
    console.error("Erro ao carregar vendas:", err);
    showToast("Erro", "N√£o foi poss√≠vel carregar vendas");
  }
}

async function carregarAuditoria() {
  if (!isAdmin()) {
    showToast("Acesso negado", "Apenas administradores podem visualizar logs de auditoria");
    return;
  }

  const token = localStorage.getItem("token");
  try {
    const res = await fetch("http://localhost:3000/api/dados/auditoria?limit=200", {
      headers: { Authorization: `Bearer ${token}` }
    });
    const json = await res.json();
    if (json.ok) {
      renderizarAuditoria(json.data);
    } else {
      showToast("Erro", json.message || "N√£o foi poss√≠vel carregar logs de auditoria");
    }
  } catch (err) {
    console.error("Erro ao carregar auditoria:", err);
    showToast("Erro", "N√£o foi poss√≠vel carregar logs de auditoria");
  }
}

function renderizarAuditoria(logs) {
  const tbody = document.getElementById("auditoria-tbody");
  if (!tbody) return;
  
  tbody.innerHTML = "";

  if (!logs || logs.length === 0) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" style="text-align: center; padding: 20px;">Nenhum log de auditoria encontrado</td>`;
    tbody.appendChild(tr);
    return;
  }

  logs.forEach(log => {
    const tr = document.createElement("tr");
    const dataHora = new Date(log.created_at).toLocaleString("pt-BR");
    const usuario = log.usuario_nome || log.username || "-";
    const funcao = log.usuario_role || "-";
    const acao = log.action || "-";
    const entidade = log.resource || "-";
    const idEntidade = log.resource_id || "-";
    const detalhes = log.error_message 
      ? `Erro: ${log.error_message}` 
      : `${log.method} ${log.endpoint}`;

    tr.innerHTML = `
      <td>${dataHora}</td>
      <td>${usuario}</td>
      <td>${funcao}</td>
      <td>${acao}</td>
      <td>${entidade}</td>
      <td>${idEntidade}</td>
      <td style="font-size: 0.9em; color: ${log.response_status >= 400 ? 'red' : 'inherit'}">${detalhes}</td>
    `;
    tbody.appendChild(tr);
  });
}

function formatarData(data) {
  if (!data) return "-"; // mostra tra√ßo se for null
  const d = new Date(data);
  return d.toLocaleDateString("pt-BR"); // ex: 10/01/2025
}


function renderizarVendas(vendas) {
  const tbody = document.getElementById("vendas-tbody");
  tbody.innerHTML = "";

  vendas.forEach(v => {
    const tr = document.createElement("tr");

    const podeEditar = canPerform('vendas', 'edit');
    const podeRemover = canPerform('vendas', 'remove');
    let acoes = "";
    if (podeEditar || podeRemover) {
      acoes = `
        ${podeEditar ? `<button onclick="onEditarVendaClick(${v.id})" class="md-btn-text">
          <span class="material-icons">edit</span>
        </button>` : ""}
        ${podeRemover ? `<button onclick="onRemoverVendaClick(${v.id})" class="md-btn-text">
          <span class="material-icons">delete</span>
        </button>` : ""}
      `;
    }

    tr.innerHTML = `
      <td>${v.id}</td>
      <td>${v.cliente}</td>
      <td>${v.vendedor}</td>
      <td>R$ ${v.total}</td>
      <td>${v.status}</td>
      <td>${v.forma_pagamento}</td>
      <td>${formatarData(v.data_compra)}</td>
      <td>${formatarData(v.data_entrega)}</td>
      <td>${acoes}</td>
    `;

    tbody.appendChild(tr);
  });
}


/* =====================================================================
      EXPORTAR PARA ESCOPO GLOBAL (NECESS√ÅRIO PARA onclick)
===================================================================== */
window.abrirPagina = abrirPagina;
window.carregarDashboard = carregarDashboard;
window.carregarClientes = carregarClientes;
window.carregarProdutos = carregarProdutos;
window.carregarVendas = carregarVendas;
window.carregarAuditoria = carregarAuditoria;
window.doLogin = doLogin;
window.abrirRecuperacao = abrirRecuperacao;
window.fecharRecuperacao = fecharRecuperacao;
window.confirmarRecuperacao = confirmarRecuperacao;
window.alterarAvatar = alterarAvatar;
window.fecharPerfilSidebar = fecharPerfilSidebar;
window.pedirLogout = pedirLogout;
window.fecharCadastro = fecharCadastro;
window.abrirCadastro = abrirCadastro;
window.confirmarCadastro = confirmarCadastro;

/* ====================== ADI√á√ÉO: Handlers CRUD que realmente chamam backend e auditam ====================== */

/* Confirmar credenciais de admin (confirma√ß√£o extra) */
async function confirmarAdmin() {
  if (!isAdmin()) return false;
  const result = await openCrudForm({
    title: 'Confirma√ß√£o de Administrador',
    submitLabel: 'Confirmar',
    fields: [
      {
        name: 'password',
        label: 'Digite sua senha',
        type: 'password',
        required: true,
        autocomplete: 'current-password'
      }
    ]
  });
  if (result === null) return false;
  const senha = result.password?.trim();
  if (!senha) return false;
  try {
    const token = localStorage.getItem("token");
    const r = await fetch("http://localhost:3000/api/admin/confirm", {
      method: "POST",
      headers: { "Content-Type":"application/json", Authorization: `Bearer ${token}` },
      body: JSON.stringify({ cpf: currentUser.cpf, password: senha })
    });
    return r.ok;
  } catch {
    showToast("Erro", "Falha na confirma√ß√£o de admin");
    return false;
  }
}

/* Auditoria (registra apenas quando logado como admin) */
function registrarAuditoria(acao, entidade, idEntidade, detalhes="-") {
  if (!isAdmin()) return;
  const tbody = document.getElementById("auditoria-tbody");
  if (!tbody) return;
  const tr = document.createElement("tr");
  const agora = new Date().toLocaleString("pt-BR");
  tr.innerHTML = `
    <td>${agora}</td>
    <td>${getUserName()}</td>
    <td>${getUserRole()}</td>
    <td>${acao}</td>
    <td>${entidade}</td>
    <td>${idEntidade ?? "-"}</td>
    <td>${detalhes}</td>
  `;
  tbody.appendChild(tr);
}

/* CLIENTES */
async function onAdicionarClienteClick() {
  if (!canPerform('clientes', 'add')) {
    showToast("Acesso negado", "Somente administradores podem adicionar clientes");
    return;
  }
  if (!(await confirmarAdmin())) { showToast("Erro", "Confirma√ß√£o de admin falhou"); return; }
  const payload = await collectClientePayload();
  if (payload === null) { showToast("Cancelado", "Opera√ß√£o cancelada"); return; }
  if (payload === undefined) return;
  try {
    const result = await apiRequest('POST', '/clientes', payload);
    showToast("Sucesso", "Cliente adicionado");
    carregarClientes();
    registrarAuditoria("Adicionar","Cliente", result.data?.id);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onEditarClienteClick(id) {
  if (!canPerform('clientes', 'edit')) { showToast("Acesso negado","Sem permiss√£o para editar clientes"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID do cliente que deseja editar:");
    if (targetId === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    const cliente = await apiRequest('GET', `/clientes/${targetId}`);
    const payload = await collectClientePayload(cliente.data);
    if (payload === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (payload === undefined) return;
    await apiRequest('PUT', `/clientes/${targetId}`, payload);
    showToast("Sucesso","Cliente atualizado");
    carregarClientes();
    registrarAuditoria("Editar","Cliente", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onRemoverClienteClick(id) {
  if (!canPerform('clientes', 'remove')) { showToast("Acesso negado","Somente administradores podem remover clientes"); return; }
  if (!(await confirmarAdmin())) { showToast("Erro", "Confirma√ß√£o de admin falhou"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID do cliente que deseja remover:");
    if (targetId === null) { showToast("Cancelado","Opera√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    await apiRequest('DELETE', `/clientes/${targetId}`);
    showToast("Sucesso","Cliente removido");
    carregarClientes();
    registrarAuditoria("Remover","Cliente", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}

/* PRODUTOS */
async function onAdicionarProdutoClick() {
  if (!canPerform('produtos', 'add')) { showToast("Acesso negado","Somente administradores podem adicionar produtos"); return; }
  if (!(await confirmarAdmin())) { showToast("Erro", "Confirma√ß√£o de admin falhou"); return; }
  const payload = await collectProdutoPayload();
  if (payload === null) { showToast("Cancelado","Opera√ß√£o cancelada"); return; }
  if (payload === undefined) return;
  try {
    const result = await apiRequest('POST', '/produtos', payload);
    showToast("Sucesso","Produto adicionado");
    carregarProdutos();
    registrarAuditoria("Adicionar","Produto", result.data?.id);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onEditarProdutoClick(id) {
  if (!canPerform('produtos', 'edit')) { showToast("Acesso negado","Sem permiss√£o para editar produtos"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID do produto que deseja editar:");
    if (targetId === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    const produto = await apiRequest('GET', `/produtos/${targetId}`);
    const payload = await collectProdutoPayload(produto.data);
    if (payload === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (payload === undefined) return;
    await apiRequest('PUT', `/produtos/${targetId}`, payload);
    showToast("Sucesso","Produto atualizado");
    carregarProdutos();
    registrarAuditoria("Editar","Produto", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onRemoverProdutoClick(id) {
  if (!canPerform('produtos', 'remove')) { showToast("Acesso negado","Somente administradores podem remover produtos"); return; }
  if (!(await confirmarAdmin())) { showToast("Erro", "Confirma√ß√£o de admin falhou"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID do produto que deseja remover:");
    if (targetId === null) { showToast("Cancelado","Opera√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    await apiRequest('DELETE', `/produtos/${targetId}`);
    showToast("Sucesso","Produto removido");
    carregarProdutos();
    registrarAuditoria("Remover","Produto", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}

/* VENDAS */
async function onAdicionarVendaClick() {
  if (!canPerform('vendas', 'add')) { showToast("Acesso negado","Sem permiss√£o para adicionar vendas"); return; }
  const payload = await collectVendaPayload();
  if (payload === null) { showToast("Cancelado","Opera√ß√£o cancelada"); return; }
  if (payload === undefined) return;
  payload.itens = Array.isArray(payload.itens) ? payload.itens : [];
  try {
    const result = await apiRequest('POST', '/vendas', payload);
    showToast("Sucesso","Venda adicionada");
    carregarVendas();
    registrarAuditoria("Adicionar","Venda", result.data?.id);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onEditarVendaClick(id) {
  if (!canPerform('vendas', 'edit')) { showToast("Acesso negado","Sem permiss√£o para editar vendas"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID da venda que deseja editar:");
    if (targetId === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    const venda = await apiRequest('GET', `/vendas/${targetId}`);
    const payload = await collectVendaPayload(venda.data);
    if (payload === null) { showToast("Cancelado","Edi√ß√£o cancelada"); return; }
    if (payload === undefined) return;
    await apiRequest('PUT', `/vendas/${targetId}`, payload);
    showToast("Sucesso","Venda atualizada");
    carregarVendas();
    registrarAuditoria("Editar","Venda", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}
async function onRemoverVendaClick(id) {
  if (!canPerform('vendas', 'remove')) { showToast("Acesso negado","Somente administradores podem remover vendas"); return; }
  if (!(await confirmarAdmin())) { showToast("Erro", "Confirma√ß√£o de admin falhou"); return; }
  let targetId = id;
  if (!targetId) {
    targetId = await askForId("Informe o ID da venda que deseja remover:");
    if (targetId === null) { showToast("Cancelado","Opera√ß√£o cancelada"); return; }
    if (targetId === undefined) return;
  }
  try {
    await apiRequest('DELETE', `/vendas/${targetId}`);
    showToast("Sucesso","Venda removida");
    carregarVendas();
    registrarAuditoria("Remover","Venda", targetId);
  } catch (err) {
    showToast("Erro", err.message);
  }
}

</script>
</body>
</html>